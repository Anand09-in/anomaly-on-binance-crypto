name: Build & Deploy Binance Producer

on:
  push:
    branches: [ main ]
    paths:
      - "Kafka/Producer/**"
      - ".github/workflows/deploy-producer.yaml"
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Override image tag (default: latest)"
        required: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
      KAFKA_EC2_USER: ubuntu
      PROJECT_NAME: crypto-anom-ml   # <- change if your var.project_name is different

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine image tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            TAG="latest"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build & Push Producer image
        working-directory: ./Kafka/Producer
        run: |
          IMAGE_NAME=crypto-anom-ml-binance-producer
          TAG=${{ steps.tag.outputs.tag }}
          FULL_IMAGE="$ECR_REGISTRY/$IMAGE_NAME:$TAG"

          echo "Building $FULL_IMAGE"
          docker build -t "$FULL_IMAGE" .
          docker push "$FULL_IMAGE"

          echo "FULL_IMAGE=$FULL_IMAGE" >> $GITHUB_ENV

      # ðŸ‘‡ NEW: dynamically discover Kafka EC2 host by Name tag
      - name: Discover Kafka EC2 public DNS
        id: discover
        run: |
          HOST=$(
            aws ec2 describe-instances \
              --filters "Name=tag:Name,Values=${PROJECT_NAME}-kafka-node" "Name=instance-state-name,Values=running" \
              --query "Reservations[0].Instances[0].PublicDnsName" \
              --output text
          )

          echo "Discovered Kafka host: $HOST"

          if [ "$HOST" = "None" ] || [ -z "$HOST" ]; then
            echo "ERROR: Could not find running EC2 with tag Name=${PROJECT_NAME}-kafka-node"
            exit 1
          fi

          echo "KAFKA_EC2_HOST=$HOST" >> $GITHUB_ENV

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.KAFKA_EC2_SSH_KEY }}

      - name: Deploy producer on EC2 (git clone/pull + producer_start.sh)
        run: |
          echo "Deploying to $KAFKA_EC2_HOST"
          ssh -o StrictHostKeyChecking=no $KAFKA_EC2_USER@$KAFKA_EC2_HOST <<EOF
            set -euo pipefail

            REPO_DIR="/home/ubuntu/repo"
            REPO_URL="${{ secrets.DEPLOY_REPO_URL }}"
            BRANCH="${KAFKA_GIT_BRANCH:-main}"

            echo "[deploy] ensure repo dir: \$REPO_DIR"
            if [ ! -d "\$REPO_DIR/.git" ]; then
              echo "[deploy] Repo .git not found. Attempting clone: \$REPO_URL (branch \$BRANCH)"
              sudo -u ubuntu mkdir -p "\$REPO_DIR"
              sudo -u ubuntu git clone -b "\$BRANCH" "$REPO_URL" "\$REPO_DIR" || {
                echo "[deploy] ERROR: git clone failed. Check connectivity/auth from EC2."
                ls -la /home/ubuntu || true
                exit 1
              }
            else
              echo "[deploy] Repo exists. Updating..."
              cd "\$REPO_DIR"
              sudo -u ubuntu git fetch --all --prune
              sudo -u ubuntu git checkout "\$BRANCH" || sudo -u ubuntu git checkout -b "\$BRANCH" origin/"$BRANCH"
              sudo -u ubuntu git reset --hard origin/"$BRANCH"
            fi

            echo "[deploy] Repo ready. owner/perm:"
            ls -ld "\$REPO_DIR" || true
            ls -la "\$REPO_DIR" | sed -n '1,80p' || true

            # Provide the newly-built image name to the remote session (expanded by runner)
            export PRODUCER_IMAGE="${FULL_IMAGE}"
            export AWS_REGION="${{ secrets.AWS_REGION }}"
            export ECR_REGISTRY="${{ secrets.ECR_REGISTRY }}"

            echo "[deploy] Running producer_start.sh via ubuntu user..."
            PRODUCER_SCRIPT="\$REPO_DIR/Kafka/Producer/producer_start.sh"
            if [ ! -f "\$PRODUCER_SCRIPT" ]; then
              echo "[deploy] ERROR: \$PRODUCER_SCRIPT not found"
              exit 1
            fi

            chmod +x "\$PRODUCER_SCRIPT"
            sudo -u ubuntu bash -lc "\$PRODUCER_SCRIPT"
          EOF

